# 任务列表：应用程序单例化

**输入**: 来自 `/specs/001-app-singleton/` 的设计文档
**前置条件**: plan.md（必需）、spec.md（必需）、research.md

**测试**: 本项目无测试框架，所有验证通过手动测试完成。

**组织方式**: 任务按用户故事分组，支持独立实现和测试。

## 格式说明：`[ID] [P?] [Story] 描述`

- **[P]**: 可并行执行（不同文件，无依赖）
- **[Story]**: 所属用户故事（US1、US2）
- 描述中包含精确文件路径

---

## 阶段 1：基础准备

**目的**: 确认现有代码结构，为实现做准备

- [x] T001 阅读并理解 `src/app.py` 中的完整启动流程和 `if __name__ == "__main__":` 入口结构
- [x] T002 确认 `src/common.py` 中的 `APP_NAME` 常量可用于 Mutex 命名

**检查点**: 了解现有入口逻辑，确认 Mutex 检测代码的插入位置（`QApplication` 创建之前）

---

## 阶段 2：用户故事 1 - 防止重复启动应用程序 (P1) 🎯 MVP

**目标**: 通过 Windows Named Mutex 实现单例检测，当已有实例运行时阻止新实例启动并激活已有实例窗口

**独立测试**: 启动应用程序一次 → 再次启动 → 验证第二个实例被拦截且已有实例的设置窗口被激活

### 实现

- [x] T003 [US1] 在 `src/app.py` 顶部添加 `win32event`、`win32api`、`win32gui`、`winerror` 的 import 语句
- [x] T004 [US1] 在 `src/app.py` 的 `if __name__ == "__main__":` 入口中、`QApplication` 创建之前，添加 `CreateMutex` 调用创建命名 Mutex `"nightreign-overlay-helper-singleton"`，并通过 `GetLastError() == ERROR_ALREADY_EXISTS` 检测是否已有实例运行
- [x] T005 [US1] 在 `src/app.py` 中实现已有实例激活逻辑：当检测到已有实例时，通过 `win32gui.FindWindow(None, "{APP_FULLNAME} - 设置")` 查找设置窗口，若找到则调用 `win32gui.ShowWindow` 和 `win32gui.SetForegroundWindow` 激活该窗口，然后调用 `sys.exit(0)` 退出新实例
- [x] T006 [US1] 在 `src/app.py` 中处理未找到设置窗口的情况：当已有实例运行但设置窗口未打开时，记录日志提示用户已有实例在运行，然后调用 `sys.exit(0)` 退出
- [x] T007 [US1] 将 Mutex 句柄存储在模块级变量中（防止被垃圾回收释放），确保 Mutex 在整个应用程序生命周期内保持有效

**检查点**: 此时用户故事 1 应可完整工作 — 首次启动正常运行，重复启动被拦截并激活已有实例

---

## 阶段 3：用户故事 2 - 异常退出后可正常重启 (P2)

**目标**: 确保应用程序异常退出后 Mutex 被操作系统自动释放，用户可立即重新启动

**独立测试**: 启动应用 → 通过任务管理器强制终止进程 → 立即重新启动 → 验证启动成功

### 验证与加固

- [ ] T008 [US2] 手动验证崩溃恢复：启动应用 → 任务管理器终止进程 → 重新启动，确认 Windows 内核自动释放了 Mutex 句柄
- [x] T009 [US2] 在 `src/app.py` 中为单例检测逻辑添加异常处理：若 `CreateMutex` 调用本身失败（如权限问题），记录 warning 日志但不阻止程序启动（降级为允许多实例）

**检查点**: 用户故事 1 和 2 均可独立工作 — 正常单例行为 + 异常退出后可恢复

---

## 阶段 4：收尾与跨功能关注点

**目的**: 确保整体质量和兼容性

- [ ] T010 运行 `quickstart.md` 中的全部 5 项验证步骤，确认所有场景通过
- [ ] T011 使用 `.\build.bat` 构建 PyInstaller 可执行文件，验证打包后的程序同样具备单例行为

---

## 依赖关系与执行顺序

### 阶段依赖

- **阶段 1（基础准备）**: 无依赖，立即开始
- **阶段 2（用户故事 1）**: 依赖阶段 1 完成
- **阶段 3（用户故事 2）**: 依赖阶段 2 完成（需要 Mutex 逻辑已实现才能验证崩溃恢复）
- **阶段 4（收尾）**: 依赖阶段 2 和 3 完成

### 用户故事依赖

- **用户故事 1 (P1)**: 核心单例功能，必须先实现
- **用户故事 2 (P2)**: 基于用户故事 1 的异常场景加固，依赖 US1 的 Mutex 实现

### 阶段内并行机会

- T003 (import) 可与 T001、T002 并行（不同关注点）
- T010 和 T011（收尾阶段）为顺序执行

---

## 实现策略

### MVP 优先（仅用户故事 1）

1. 完成阶段 1：了解现有代码
2. 完成阶段 2：实现核心单例检测 + 窗口激活
3. **验证**：手动测试单例行为
4. 即可使用

### 完整交付

1. 完成 MVP → 单例检测工作正常
2. 添加用户故事 2 → 异常处理加固 → 验证崩溃恢复
3. 收尾 → PyInstaller 构建验证 → 完成

---

## 备注

- 所有修改集中在 `src/app.py` 一个文件中
- 无需新建文件或模块
- 无需添加新依赖（`pywin32` 已是项目依赖）
- Mutex 句柄由 Windows 内核管理，进程退出（包括异常退出）时自动释放
- 设置窗口标题格式为 `"{APP_FULLNAME} - 设置"`（来自 `src/ui/settings.py:852`）
