# Feature Specification: 应用程序单例化

**Feature Branch**: `001-app-singleton`
**Created**: 2026-02-08
**Status**: Draft
**Input**: User description: "我想实现此Qt应用程序的单例化(程序只运行一个实例)"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 防止重复启动应用程序 (Priority: P1)

用户双击程序图标或通过命令行启动应用程序时，如果已有一个实例在运行，系统应阻止第二个实例启动，并将用户的注意力引导到已运行的实例上。

**Why this priority**: 这是单例化功能的核心需求。没有这个功能，用户可能无意中启动多个实例，导致资源冲突（如屏幕截取冲突、快捷键冲突、系统托盘出现多个图标），影响正常使用。

**Independent Test**: 启动应用程序一次，确认正常运行；再次尝试启动，验证第二个实例被拒绝且已运行的实例获得焦点。

**Acceptance Scenarios**:

1. **Given** 应用程序未运行, **When** 用户启动应用程序, **Then** 应用程序正常启动并运行
2. **Given** 应用程序已在运行, **When** 用户尝试再次启动应用程序, **Then** 第二个实例不会启动，用户收到提示或已有实例被激活
3. **Given** 应用程序已在运行, **When** 用户尝试再次启动应用程序, **Then** 系统托盘中不会出现第二个图标

---

### User Story 2 - 异常退出后可正常重启 (Priority: P2)

如果应用程序因崩溃或异常情况退出，用户应能够正常重新启动应用程序，单例锁不应成为阻碍。

**Why this priority**: 如果单例机制在异常退出后留下残留锁，用户将无法重新启动程序，严重影响可用性。

**Independent Test**: 启动应用程序，强制终止进程，再次启动应用程序，验证可以正常启动。

**Acceptance Scenarios**:

1. **Given** 应用程序因崩溃而终止, **When** 用户重新启动应用程序, **Then** 应用程序正常启动，不会被残留锁阻止
2. **Given** 应用程序被用户通过任务管理器强制终止, **When** 用户重新启动应用程序, **Then** 应用程序正常启动

---

### Edge Cases

- 如果程序在启动过程中（尚未完全初始化）崩溃，单例锁是否能正确释放？
- 如果用户快速连续多次双击程序图标，是否能正确处理竞态条件？
- 如果用户同时从不同路径（如快捷方式和命令行）启动程序，是否都能被正确拦截？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在应用程序启动时检测是否已有实例在运行
- **FR-002**: 系统 MUST 在检测到已有实例运行时，阻止新实例的启动
- **FR-003**: 系统 MUST 在阻止新实例启动时，向用户提供明确的反馈（如激活已有实例窗口或显示提示信息）
- **FR-004**: 系统 MUST 在应用程序正常退出时释放单例锁
- **FR-005**: 系统 MUST 在应用程序异常退出后，不留下阻止重新启动的残留锁
- **FR-006**: 系统 MUST 在多次快速启动尝试时正确处理竞态条件，确保只有一个实例运行

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 当已有实例运行时，100% 的重复启动尝试被正确拦截
- **SC-002**: 应用程序异常终止后，用户可以立即成功重新启动（无需手动清理锁文件等操作）
- **SC-003**: 单例检测过程对正常启动时间的影响不超过 500 毫秒
- **SC-004**: 快速连续启动 5 次以上时，始终只有一个实例在运行

## Assumptions

- 应用程序仅在 Windows 平台运行，可以使用 Windows 特有的单例机制
- 单例范围限定为同一 Windows 用户会话
- 用户启动重复实例时，优先激活已有实例（而非仅显示错误消息后退出）
- 该功能在打包为可执行文件（PyInstaller）后同样有效
